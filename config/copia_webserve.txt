#!/usr/bin/env bash
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘   webserve - Servidor HTTP + TÃºnel PÃºblico               â•‘
# â•‘   by Shadow-TermDev | v2.0.0                             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Valores por defecto
PORT=${1:-8000}
DIR="${2:-.}"
TUNNEL_ENABLED=true

# Banner compacto
show_banner() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}  ${WHITE}ðŸŒ WEBSERVE${NC} - Servidor HTTP + TÃºnel    ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•‘${NC}      ${BLUE}Shadow-TermDev v2.0.0${NC}               ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Mostrar ayuda
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    show_banner
    echo -e "${WHITE}Uso:${NC}"
    echo -e "  webserve [puerto] [directorio]"
    echo ""
    echo -e "${WHITE}Ejemplos:${NC}"
    echo -e "  ${YELLOW}webserve${NC}                  # Puerto 8000, dir actual"
    echo -e "  ${YELLOW}webserve 3000${NC}             # Puerto 3000, dir actual"
    echo -e "  ${YELLOW}webserve 8080 /ruta${NC}       # Puerto 8080, dir especÃ­fico"
    echo ""
    echo -e "${WHITE}CaracterÃ­sticas:${NC}"
    echo -e "  â€¢ Servidor HTTP con Python"
    echo -e "  â€¢ TÃºnel pÃºblico con localhost.run o ngrok"
    echo -e "  â€¢ Logs coloreados en tiempo real"
    echo ""
    exit 0
fi

# Detectar Python
if command -v python3 >/dev/null 2>&1; then
    PYTHON="python3"
elif command -v python >/dev/null 2>&1; then
    PYTHON="python"
else
    echo -e "${RED}âœ— Python no encontrado${NC}"
    echo -e "${YELLOW}  Instala con: pkg install python${NC}"
    exit 1
fi

# Verificar directorio
if [ ! -d "$DIR" ]; then
    echo -e "${RED}âœ— Directorio '$DIR' no existe${NC}"
    exit 1
fi

cd "$DIR" || exit 1

# Obtener IP local
get_local_ip() {
    local ip=""
    if command -v ip &> /dev/null; then
        ip=$(ip addr show | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $2}' | cut -d/ -f1)
    fi
    if [ -z "$ip" ] && command -v ifconfig &> /dev/null; then
        ip=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $2}')
    fi
    [ -z "$ip" ] && ip="localhost"
    echo "$ip"
}

LOCAL_IP=$(get_local_ip)

# Detectar herramienta de tÃºnel
TUNNEL_CMD=""
TUNNEL_TYPE=""
if command -v ssh >/dev/null 2>&1; then
    TUNNEL_CMD="ssh -R 80:localhost:$PORT nokey@localhost.run"
    TUNNEL_TYPE="localhost.run"
elif command -v ngrok >/dev/null 2>&1; then
    TUNNEL_CMD="ngrok http $PORT"
    TUNNEL_TYPE="ngrok"
else
    TUNNEL_ENABLED=false
fi

# Mostrar informaciÃ³n inicial
show_banner

echo -e "${GREEN}âœ“ Servidor iniciando...${NC}"
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${WHITE}ðŸ“ Directorio:${NC}  $(pwd)"
echo -e "${WHITE}ðŸ”Œ Puerto:${NC}      $PORT"
echo ""
echo -e "${YELLOW}ðŸŒ URLs de acceso:${NC}"
echo -e "  ${GREEN}Local:${NC}       http://localhost:$PORT"
echo -e "  ${GREEN}Red local:${NC}   http://$LOCAL_IP:$PORT"

if [ "$TUNNEL_ENABLED" = true ]; then
    echo -e "  ${GREEN}PÃºblico:${NC}     (generando con $TUNNEL_TYPE...)"
fi

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BLUE}ðŸ’¡ Presiona ${YELLOW}Ctrl+C${BLUE} para detener el servidor${NC}"
echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${WHITE}ðŸ“Š Logs del servidor:${NC}"
echo ""

# Iniciar servidor en background
$PYTHON -m http.server "$PORT" 2>&1 | while IFS= read -r line; do
    # Colorear logs segÃºn tipo
    if [[ $line == *"GET"* ]]; then
        echo -e "${GREEN}[GET]${NC} $line"
    elif [[ $line == *"POST"* ]]; then
        echo -e "${BLUE}[POST]${NC} $line"
    elif [[ $line == *"404"* ]]; then
        echo -e "${RED}[404]${NC} $line"
    elif [[ $line == *"200"* ]]; then
        echo -e "${GREEN}[200]${NC} $line"
    elif [[ $line == *"Serving HTTP"* ]]; then
        echo -e "${CYAN}[INFO]${NC} $line"
    else
        echo "$line"
    fi
done & SERVER_PID=$!

# Esperar a que el servidor inicie
sleep 2

# Iniciar tÃºnel si estÃ¡ disponible
if [ "$TUNNEL_ENABLED" = true ]; then
    echo ""
    echo -e "${YELLOW}ðŸŒ Iniciando tÃºnel pÃºblico con $TUNNEL_TYPE...${NC}"
    echo ""
    
    if [[ "$TUNNEL_TYPE" == "localhost.run" ]]; then
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${WHITE}Tu URL pÃºblica aparecerÃ¡ abajo:${NC}"
        echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
    fi
    
    eval "$TUNNEL_CMD" & TUNNEL_PID=$!
else
    echo ""
    echo -e "${YELLOW}âš  Sin tÃºnel pÃºblico (ssh/ngrok no disponible)${NC}"
    echo -e "${WHITE}  Instala ssh con: ${CYAN}pkg install openssh${NC}"
    echo ""
fi

# FunciÃ³n de limpieza al salir
cleanup() {
    echo ""
    echo ""
    echo -e "${YELLOW}ðŸ›‘ Deteniendo servidor...${NC}"
    
    # Matar servidor
    if [ ! -z "$SERVER_PID" ]; then
        kill $SERVER_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
    fi
    
    # Matar tÃºnel
    if [ ! -z "$TUNNEL_PID" ]; then
        kill $TUNNEL_PID 2>/dev/null || true
        wait $TUNNEL_PID 2>/dev/null || true
    fi
    
    echo -e "${GREEN}âœ“ Servidor detenido correctamente${NC}"
    echo ""
    echo -e "${CYAN}Â¡Gracias por usar webserve! ðŸš€${NC}"
    echo ""
    exit 0
}

# Capturar Ctrl+C
trap cleanup INT TERM

# Esperar a que terminen los procesos
wait
